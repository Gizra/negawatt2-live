"use strict";angular.module("negawattClientApp",["angularMoment","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","config","LocalStorageModule","ui.router","googlechart","angular-md5","angular-loading-bar","ui.bootstrap.tabs","ui.bootstrap.alert","ui.bootstrap.accordion","ui.bootstrap.buttons","ui.bootstrap.datepicker","template/datepicker/datepicker.html","template/datepicker/popup.html","template/datepicker/day.html","template/datepicker/month.html","template/datepicker/year.html","template/tabs/tab.html","template/tabs/tabset.html","template/alert/alert.html","template/accordion/accordion-group.html","template/accordion/accordion.html","angularMoment","ui.indeterminate","angular.filter","ui.tree"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","cfpLoadingBarProvider",function(a,b,c,d){b.when("","/"),b.when("/",["$injector","$location","$state","Profile",function(a,b,c,d){d.get().then(function(a){a&&c.go("chart.withAccount",{accountId:a.account[0].id})})}]),b.otherwise(""),a.state("login",{url:"/login",templateUrl:"views/login.html"}).state("logout",{url:"/logout",template:"<ui-view/>",controller:["Auth","$state",function(a,b){a.logout(),b.go("login")}]}).state("dashboard",{"abstract":!0,url:"/dashboard",templateUrl:"views/dashboard/map/main.html",resolve:{profile:["Profile",function(a){return a.get()}]},controller:"DashboardCtrl"}).state("dashboard.withAccount",{url:"/{accountId:int}?{chartFreq:int}&{chartNextPeriod:int}&{chartPreviousPeriod:int}",reloadOnSearch:!1,params:{chartFreq:{value:2}},resolve:{account:["$stateParams","Profile","profile",function(a,b,c){return b.selectAccount(a.accountId,c)}],meters:["Meter","account",function(a,b){return a.get(b.id)}],siteCategories:["SiteCategory","account",function(a,b){return a.get(b.id)}],filters:["FilterFactory","siteCategories","$stateParams","meters","account",function(a,b,c,d,e){return a.setCategories(b),a.setElectricity(c),{loadElectricity:!0,activeElectricityHash:a.get("activeElectricityHash")}}],messages:["Message","account",function(a,b){return a.get(b)}]},views:{"menu@dashboard":{templateUrl:"views/dashboard/map/main.menu.html",controller:"MenuCtrl"},map:{templateUrl:"views/dashboard/map/main.map.html",controller:"MapCtrl",controllerAs:"map"},"categories@dashboard":{templateUrl:"views/dashboard/map/main.categories.html",controller:"CategoryCtrl"},"messages@dashboard":{templateUrl:"views/dashboard/map/main.messages.html",controller:"MessageCtrl",controllerAs:"message"},"details@dashboard":{templateUrl:"views/dashboard/map/main.details.html",controller:"DetailsCtrl",controllerAs:"chart"},"usage@dashboard":{templateUrl:"views/dashboard/map/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"}}}).state("dashboard.withAccount.categories",{url:"/category/{categoryId:int}",reloadOnSearch:!1,resolve:{meters:["Meter","$stateParams","account","FilterFactory",function(a,b,c,d){return d.set("category",+b.categoryId),a.get(c.id,b.categoryId)}],siteCategories:["SiteCategory","account",function(a,b){return a.get(b.id)}],filters:["siteCategories","$stateParams","FilterFactory",function(a,b,c){return{loadElectricity:!0,activeElectricityHash:c.get("activeElectricityHash")}}]},views:{"map@dashboard":{templateUrl:"views/dashboard/map/main.map.html",controller:"MapCtrl",controllerAs:"map"},"usage@dashboard":{templateUrl:"views/dashboard/map/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"},"categories@dashboard":{templateUrl:"views/dashboard/map/main.categories.html",controller:"CategoryCtrl"},"details@dashboard":{templateUrl:"views/dashboard/map/main.details.html",controller:"DetailsCtrl",controllerAs:"chart"}}}).state("dashboard.withAccount.markers",{url:"/marker/:markerId?categoryId",reloadOnSearch:!1,resolve:{meters:["Meter","$stateParams","account","FilterFactory",function(a,b,c,d){return d.set("category",+b.categoryId||void 0),d.set("meter",+b.markerId),a.get(c.id,b.categoryId)}],siteCategories:["SiteCategory","account",function(a,b){return a.get(b.id)}],filters:["meters","$stateParams","FilterFactory",function(a,b,c){return c.setElectricity(b),{loadElectricity:!0,activeElectricityHash:c.get("activeElectricityHash")}}]},views:{"map@dashboard":{templateUrl:"views/dashboard/map/main.map.html",controller:"MapCtrl",controllerAs:"map"},"categories@dashboard":{templateUrl:"views/dashboard/map/main.categories.html",controller:"CategoryCtrl"},"details@dashboard":{templateUrl:"views/dashboard/map/main.details.html",controller:"DetailsCtrl",controllerAs:"chart"},"usage@dashboard":{templateUrl:"views/dashboard/map/main.usage.html",controller:"UsageCtrl",controllerAs:"chart"}}}).state("chart",{"abstract":!0,url:"/chart",templateUrl:"views/dashboard/chart/main.html",resolve:{profile:["Profile",function(a){return a.get()}]},controller:"DashboardCtrl"}).state("chart.withAccount",{url:"/{accountId:int}?{chartFreq:int}&{sel}&{ids}&{climate}&{chartType}&{chartNextPeriod:int}&{chartPreviousPeriod:int}",reloadOnSearch:!1,params:{chartFreq:{value:2}},resolve:{account:["$stateParams","Profile","profile",function(a,b,c){return b.selectAccount(a.accountId,c)}],meters:["Meter","account",function(a,b){return a.get(b.id)}],propertyMeters:["PropertyMeter","account",function(a,b){return a.get(b.id)}],sites:["Site","account",function(a,b){return a.get(b.id)}],siteCategories:["SiteCategory","account",function(a,b){return a.get(b.id)}],meterCategories:["MeterCategory","account",function(a,b){return a.get(b.id)}],filters:["FilterFactory","siteCategories","$stateParams","meters","account",function(a,b,c,d,e){return a.setCategories(b),a.setElectricity(c),a.setTemperature(c),{loadElectricity:!0,activeElectricityHash:a.get("activeElectricityHash")}}],messages:["Message","account",function(a,b){return a.get(b)}]},views:{"menu@chart":{templateUrl:"views/dashboard/chart/main.menu.html",controller:"MenuCtrl"},"meters-menu@chart":{templateUrl:"views/dashboard/chart/main.meters-menu.html",controller:"MetersMenuCtrl",controllerAs:"metersMenuCtrl"},"messages@chart":{templateUrl:"views/dashboard/chart/main.messages.html",controller:"MessageCtrl",controllerAs:"message"},"usage@chart":{templateUrl:"views/dashboard/chart/main.usage.html",controller:"DetailedChartCtrl",controllerAs:"detailedChartCtrl"}}}),c.interceptors.push(["$q","Auth","$location","localStorageService",function(a,b,c,d){return{request:function(a){return a.withoutToken||a.url.match(/.html/)||angular.extend(a.headers,{"access-token":d.get("access_token")}),a},response:function(a){return a.data.access_token&&d.set("access_token",a.data.access_token),a},responseError:function(c){return 401===c.status&&b.authFailed(),a.reject(c)}}}]),d.includeSpinner=!1,d.latencyThreshold=1e3}]).run(["$rootScope","$state","$stateParams","$log","Config","amMoment",function(a,b,c,d,e,f){f.changeLocale("he"),a.$state=b,a.$stateParams=c,e.debugUiRouter&&(a.$on("$stateChangeStart",function(a,b,c,e,f){d.log("$stateChangeStart to "+b.to+"- fired when the transition begins. toState,toParams : \n",b,c)}),a.$on("$stateChangeError",function(a,b,c,e,f){d.log("$stateChangeError - fired when an error occurs during transition."),d.log(arguments)}),a.$on("$stateChangeSuccess",function(a,b,c,e,f){d.log("$stateChangeSuccess to "+b.name+"- fired once the state transition is complete.")}),a.$on("$viewContentLoaded",function(a){d.log("$viewContentLoaded - fired after dom rendered",a)}),a.$on("$stateNotFound",function(a,b,c,e){d.log("$stateNotFound "+b.to+"  - fired when a state cannot be found by its name."),d.log(b,c,e)}))}]),angular.module("negawattClientApp").controller("AccessCtrl",["$window","$scope","$state","Auth","Profile",function(a,b,c,d,e){b.loginButtonEnabled=!0,b.message={},b.login=function(e){b.loginButtonEnabled=!1,d.login(e).then(function(){a.location="#/"},function(a){c.go("login"),b.loginButtonEnabled=!0,a.data?a.data&&401===a.status?b.message.loginFailed=!0:b.message.generalError=a.statusText:b.message.noServerConnection=!0})},b.logout=function(){d.logout(),c.go("login")},b.clear=function(){b.message={}}}]),angular.module("negawattClientApp").controller("DashboardCtrl",["$scope","$timeout","$state","$stateParams","profile","Alerts",function(a,b,c,d,e,f){a.vm={alerts:f},a.cssVersion=c.is("chart.withAccount")?"v2":"v1",e?!Object.keys(d).length&&c.is("dashboard")&&(vm.defaultAccountId=e.account[0].id,c.go("dashboard.withAccount",{accountId:vm.defaultAccountId})):c.go("login")}]),angular.module("negawattClientApp").controller("UsageCtrl",["$scope","$state","$stateParams","$filter","Electricity","Chart","ChartUsagePeriod","FilterFactory","meters","filters","ChartElectricityUsage","siteCategories","profile",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this,o=g.getChartPeriod;n.electricity,angular.isDefined(c.chartFreq)&&f.setActiveFrequency(c.chartFreq),angular.isDefined(c.markerId)&&(a.meterSelected=i.list[c.markerId]),c.markerId?a.title=i.list[c.markerId]?i.list[c.markerId].label:null:c.categoryId?a.title=l.list[c.categoryId]?l.list[c.categoryId].label:null:angular.forEach(m.account,function(b){b.id==c.accountId&&(a.title=b.label)}),j.loadElectricity&&e.refresh(j.activeElectricityHash),a.$on("nwElectricityChanged",function(b,c){var e;if(!angular.isUndefined(c)){if(e=d("activeElectricityFilters")(c,"noData"),o().isConfigured()||g.config(d("activeElectricityFilters")(c,"limits")),e&&o().isConfigured())return void k.requestElectricity(g.stateParams);if(n.electricity=d("activeElectricityFilters")(c),n.electricity&&n.electricity.length){var f=n.electricity[0],h=n.electricity[n.electricity.length-1];a.dateRange=g.formatDateRange(1e3*f.timestamp,1e3*h.timestamp)}}})}]),angular.module("negawattClientApp").controller("MapCtrl",["$scope","$state","$stateParams","$location","$filter","Map","leafletData","$timeout","account","meters","FilterFactory",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){var b=f.getMarkerSelected();angular.isDefined(b)&&angular.isDefined(n.meters[b])&&n.meters[f.getMarkerSelected()].unselect(),angular.isDefined(n.meters[a])&&(n.meters[a].select(),f.setMarkerSelected(a),o=!0)}function l(a){var b=f.getMarkerSelected();angular.isDefined(b)&&angular.isDefined(n.meters[b])&&n.meters[f.getMarkerSelected()].unselect(),angular.isDefined(n.meters[a])&&(n.meters[a].select(),f.setMarkerSelected(a),o=!0)}function m(a){return k.isDefine("category")?e("setMetersOptionsByActiveCategory")(angular.copy(a),{transparent:!0},"noActiveCategory"):a}var n=this,o=!1;n.defaults=f.getConfig(),n.center=f.getCenter(i),n.meters=b.is("dashboard.withAccount")?j.listAll:m(j.list),c.markerId&&(o=!!l(c.markerId)),a.$on("leafletDirectiveMarker.mouseover",function(a,b){var d=b.markerName;if(c.openedPopup!==d){c.openedPopup=d;var e=b.leafletEvent.target;e.openPopup()}}),a.$on("leafletDirectiveMarker.mouseout",function(a,b){var d=b.leafletEvent.target;d.closePopup(),c.openedPopup=null}),a.$on("leafletDirectiveMap.dragend",function(){g.getMap().then(function(a){f.setCenter(a.getCenter())})}),a.$on("leafletDirectiveMap.zoomend",function(){g.getMap().then(function(a){f.updateCenterZoom(a.getZoom())})}),a.$on("leafletDirectiveMap.load",function(a,b){g.getMap().then(function(a){a.setActiveArea("map-activearea").setView([n.center.lat,n.center.lng],n.center.zoom,{reset:!0})})}),a.$on("nwMetersChanged",function(a,b){n.meters=m(b.list),k.get("meter")&&n.meters[k.get("meter")]&&!o&&l(k.get("meter"))}),a.$on("leafletDirectiveMarker.click",function(a,c){b.forceGo("dashboard.withAccount.markers",{markerId:c.modelName,categoryId:k.get("category")})})}]),angular.module("negawattClientApp").controller("CategoryCtrl",["$scope","$state","$stateParams","$filter","SiteCategory","Meter","FilterFactory","siteCategories","meters",function(a,b,c,d,e,f,g,h,i){function j(a){g.set("category",a)}a.categories=h,a.accountId=c.accountId,a.chartFreq=c.chartFreq,a.filterMeters=g.showCategoryFilters(),angular.isUndefined(h.collection[c.categoryId])&&b.is("dashboard.withAccount.categories")?a.vm.alerts["new"]({type:"default",msg:"קטגוריה לא קיימת."}):j(c.categoryId),a.toggleMetersByCategory=function(b){var c={};c[b.id]=b.checked,g.setCategories(c),a.$parent.$broadcast("nwMetersChanged",{list:g.byCategoryFilters(i)})},a.select=function(a){g.clearMeterSelection(),b.forceGo("dashboard.withAccount.categories",{categoryId:a})},a.$on("nwMetersChanged",function(d,f){e.get(c.accountId).then(function(c){b.setGlobal("siteCategories",c),a.categories=c})})}]),angular.module("negawattClientApp").controller("DetailedChartCtrl",["$scope","$state","$stateParams","$filter","Electricity","Chart","ChartUsagePeriod","FilterFactory","meters","filters","ChartElectricityUsage","siteCategories","sites","profile",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=this;o.hasExtraChart=!1,o.account=c.accountId;a.siteCategories=l,a.sites=m,a.meters=i,angular.isDefined(c.chartFreq)&&f.setActiveFrequency(c.chartFreq),angular.isDefined(c.markerId)&&(a.meterSelected=i.list[c.markerId]),c.markerId?this.title=i.list[c.markerId]?i.list[c.markerId].label:null:c.categoryId?this.title=l.list[c.categoryId]?l.list[c.categoryId].label:null:angular.forEach(n.account,function(a){return a.id==c.accountId?void(this.title=a.label):void 0},o),a.$on("sitePropertiesCtrlChange",function(a,b){o.siteProperties=b?b:void 0})}]),angular.module("negawattClientApp").controller("DetailsCtrl",["$scope","$state","$stateParams","FilterFactory","Chart","ChartCategories","meters","$filter","siteCategories",function(a,b,c,d,e,f,g,h,i){function j(b){a.meterSelected=g.list[b]}function k(){return q.categoriesChart.data&&!!q.categoriesChart.data.rows.length}function l(){angular.isDefined(q.dataset)&&m(q.dataset.summary,a.meters.listAll)}function m(a,b){q.categoriesChart=h("toPieChartDataset")(a,b)}function n(){angular.isUndefined(a.meterSelected)&&b.is("dashboard.withAccount.markers")&&a.detailsCtrl.alerts["new"]({type:"default",msg:"מונה לא קיים."})}var o,p,q=this;a.categories=i,a.meters=g,q.categoriesChart={},q.message=e.messages.empty,q.hasData=k,q.dataset,c.markerId&&(j(c.markerId),n()),a.onSelect=function(a,d){"site_categories"===p.type&&(o=f.getCategoryIdSelected(a,d),angular.isDefined(o)&&b.go("dashboard.withAccount.categories",{accountId:c.accountId,categoryId:o}))},a.$on("nwMetersChanged",function(b,d){a.meterSelected=d.list[c.markerId],q.metersLoaded=d.loaded,d.loaded&&(n(),l())}),a.$on("nwElectricityChanged",function(b,e){if(!angular.isDefined(c.markerId)){var f;p=h("summary")(e[d.get("activeElectricityHash")]),angular.isUndefined(p)||("site_categories"===p.type?(f=a.categories.collection,m(p,f)):(f={},q.dataset={summary:p,labels:f}),q.metersLoaded=g.loaded,q.metersLoaded&&l())}})}]),angular.module("negawattClientApp").controller("MenuCtrl",["$scope","$state","$stateParams","$location","$window","amMoment","Timedate","SiteCategory","MeterCategory","account","profile","FilterFactory","Meter",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.account=j,a.user=k.user,a.timedate=g,a.accountId=c.accountId,a.reloadDashboard=function(){l.clear(),h.reset(),i.reset(),m.refresh(),b.go("dashboard.withAccount")}}]),angular.module("negawattClientApp").controller("MessageCtrl",["$scope","$state","$filter","FilterFactory","messages",function(a,b,c,d,e){var f=this;a.messages=c("groupBy")(e,"meter"),f.selectMeter=function(a,c){b.forceGo("dashboard.withAccount.markers",{markerId:c,categoryId:d.get("category")}),a.stopPropagation()}}]),angular.module("negawattClientApp").controller("ChartOptionsCtrl",["$scope","Chart",function(a,b){var c=this;c.select=function(){b.set=this.compareWith}}]),angular.module("negawattClientApp").controller("MetersMenuCtrl",["$scope","$state","$stateParams","$filter","ChartDetailedService","SiteCategory","siteCategories","MeterCategory","meterCategories","Meter","meters","PropertyMeter","propertyMeters","Site","sites","FilterFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(b){var c=p.addSiteSelected(b);a.disableMeters=c,a.disableCategories=c,e.getElectricity()}function r(){if(c.ids){var b=c.ids.split(",");switch(b=b.map(function(a){return+a}),c.sel){case"meter":angular.forEach(a.meters,function(a){a.selected=-1!=b.indexOf(+a.id)}),a.disableSites=!0,a.disableCategories=!0;break;case"meter_site":angular.forEach(g.collection,function(a){angular.forEach(a.children,function(a){a.selected=a.isSite&&-1!=b.indexOf(a.id)})}),a.disableMeters=!0,a.disableCategories=!0;break;case"site_category":angular.forEach(g.collection,function(a){a.selected=-1!=b.indexOf(a.id)}),a.disableSites=!0,a.disableMeters=!0}}if(c.climate){var d=c.climate.split(",");angular.forEach(m.listAll,function(a){a.selected=-1!=d.indexOf(a.id)})}}var s=this;a.tab="sites",a.meters=k.listAll,a.propertyMeters=m.listAll,a.siteCategoriesTree=g.tree,a.meterCategoriesTree=i.tree,r(),s.reloadCategories=function(c){f.get(c).then(function(c){b.setGlobal("siteCategories",c),a.siteCategories=c}),h.get(c).then(function(c){b.setGlobal("meterCategories",c),a.meterCategories=c})},s.clearAll=function(){var b=angular.element(".by-site input");angular.forEach(b,function(a){a.checked=!1}),a.disableSites=!1,a.disableMeters=!1,a.disableCategories=!1,p.updateSelection(void 0,void 0),e.getElectricity()},a.selectMeter=function(b){var c=a.meters[b],d=p.addMeterSelected(c);a.disableSites=d,a.disableCategories=d,e.getElectricity()},a.selectCategory=function(b){if(b.isSite)return void q(b);var c=p.addSiteCategorySelected(b);a.disableSites=c,a.disableMeters=c,e.getElectricity()},a.selectTemperature=function(a){p.addClimateSelected(a);e.getTemperature(a)},a.$on("nwSitesChanged",function(){s.reloadCategories(c.accountId)}),a.$on("nwMetersChanged",function(){s.reloadCategories(c.accountId)})}]),angular.module("negawattClientApp").controller("SitePropertyCtrl",["$scope","$rootScope","Site",function(a,b,c){function d(){c.properties.compareWith=this.compareWith,f(c.properties)}function e(){c.properties.meter=this.meter,f(c.properties)}function f(a){b.$broadcast("sitePropertiesCtrlChange",a)}var g=angular.extend,h=this;g(h,{change:d,selectMeter:e})}]),angular.module("negawattClientApp").factory("Alerts",["$timeout",function(a){var b=[],c={"new":function(c){b.push(c),a(this.close,3e3,!0,b.length-1)},close:function(a){b.splice(a,1)}};return b=angular.extend(b,c)}]),angular.module("negawattClientApp").service("Auth",["$injector","$rootScope","Utils","localStorageService","Config",function(a,b,c,d,e){this.login=function(b){return a.get("$http")({method:"GET",url:e.backend+"/api/login-token",headers:{Authorization:"Basic "+c.Base64.encode(b.username+":"+b.password)},withoutToken:!0})},this.logout=function(){d.remove("access_token"),b.$broadcast("nwClearCache")},this.isAuthenticated=function(){return!!d.get("access_token")},this.authFailed=function(){a.get("$state").go("login"),this.logout()}}]),angular.module("negawattClientApp").factory("Chart",["$filter","Utils",function(a,b){function c(){return{1:{frequency:"years",label:"שנים",type:"1",unit_num_seconds:31536e3,chart_default_time_frame:10,axis_v_title:'קוט"ש בשנה',axis_h_format:"yyyy",tooltip_format:"YYYY",axis_h_title:"שנה",get_period:function(a){var b=moment.unix(a).year();return{from:moment({y:b-9}).unix(),to:moment({y:b+1}).unix()}}},2:{frequency:"year",label:"שנה",type:"2",unit_num_seconds:2678400,chart_default_time_frame:24,axis_v_title:'קוט"ש בחודש',axis_h_format:"MM/yyyy",tooltip_format:"MM/YYYY",axis_h_title:"חודש",get_period:function(a){var b=moment.unix(a).year();return{from:moment({y:b-1}).unix(),to:moment({y:b+1}).unix()}}},3:{frequency:"month",label:"חודש",type:"3",unit_num_seconds:86400,chart_default_time_frame:31,axis_v_title:'קוט"ש ביום',axis_h_format:"dd/MM\nEEE",tooltip_format:"DD/MM/YY",axis_h_title:"תאריך",get_period:function(a){var b=moment.unix(a).year(),c=moment.unix(a).month();return{from:moment({y:b,M:c}).unix(),to:moment({y:b,M:c+1}).unix()}}},4:{frequency:"week",label:"שבוע",type:"4",unit_num_seconds:3600,chart_default_time_frame:168,axis_v_title:"KW",axis_h_format:"dd/MM\nEEE",tooltip_format:"HH:mm dd/MM",axis_h_title:"שעה",get_period:function(a){var b=moment.unix(a).year(),c=moment.unix(a).month(),d=moment.unix(a).date(),e=moment.unix(a).day();return{from:moment({y:b,M:c,d:d-e}).unix(),to:moment({y:b,M:c,d:d-e+7}).unix()}}},5:{frequency:"day",label:"יום",type:"5",unit_num_seconds:60,chart_default_time_frame:1440,axis_v_title:"KW",axis_h_format:"HH:mm\ndd/MM",tooltip_format:"HH:mm DD/MM",axis_h_title:"שעה",get_period:function(a){var b=moment.unix(a).year(),c=moment.unix(a).month(),d=moment.unix(a).date();return{from:moment({y:b,M:c,d:d}).unix(),to:moment({y:b,M:c,d:d+1}).unix()}}}}}function d(){angular.forEach(h.frequencies,function(a){a.active=""})}function e(a){return h[a]||void 0}function f(a){return a.active&&a}var g=angular.isDefined,h={frequencies:c(),multipleGraphs:!1};return{messages:{empty:"אין מספיק נתונים כדי להציג את התרשים."},getFrequencies:function(a){return g(a)?e("frequencies")[a]:e("frequencies")},setActiveFrequency:function(a){d(),h.frequencies[a].active="active"},getActiveFrequency:function(){return a("filter")(b.toArray(h.frequencies),f,!0)[0]},formatDateRange:function(a,b){switch(this.getActiveFrequency().frequency){case"years":case"year":var c="YYYY";break;case"month":var c="MM/YYYY";break;case"week":case"day":var c="DD/MM/YYYY"}switch(this.getActiveFrequency().frequency){case"year":case"week":case"day":case"hour":return moment(a).format(c)+"-"+moment(b).format(c);case"month":return moment(a).format(c)}}}}]),angular.module("negawattClientApp").factory("ChartOptions",["$stateParams","$window","Chart","moment",function(a,b,c,d){function e(){var e=angular.element(b),f=e.width(),g=(e.height(),c.getActiveFrequency());return{height:"350",width:7*f/12-150,titlePosition:"none",legend:{maxLines:3,position:"top"},backgroundColor:"none",vAxis:{title:g.axis_v_title,format:"short",gridlines:{count:5}},hAxis:{minValue:d.unix(a.chartPreviousPeriod).toDate(),maxValue:d.unix(a.chartNextPeriod-1).toDate(),format:g.axis_h_format},tooltip:{isHtml:!0},crosshair:{trigger:"both",orientation:"vertical"}}}function f(){return n(e(),{chart_type:"LineChart"})}function g(a){a=1==a?4:a;for(var b={},d=0;a>d;d++)b[d]={targetAxisIndex:0};b[a]={targetAxisIndex:1};var f=c.getActiveFrequency();return n(e(),{chart_type:"LineChart",series:b,vAxes:{0:{title:f.axis_v_title,format:"short"},1:{title:"טמפרטורה",format:"short"}}})}function h(a){switch(a=a?a:"sum"){case"sum":case"stacked":return!0;case"percent":return"percent";default:return!1}}function i(a){return n(e(),{chart_type:"ColumnChart",isStacked:h(a),fill:20,displayExactValues:!0,bar:{groupWidth:"75%"}})}function j(a,b){b=1==b?4:b;for(var d={},f=0;b>f;f++)d[f]={targetAxisIndex:0};d[b]={targetAxisIndex:1,type:"line"};var g=c.getActiveFrequency();return n(e(),{chart_type:"ColumnChart",isStacked:h(a),fill:20,displayExactValues:!0,series:d,vAxes:{0:{title:g.axis_v_title,format:"short"},1:{title:"טמפרטורה",format:"short",chart_type:"LineChart"}}})}function k(a){switch(+a){case 1:case 2:case 3:return"columnChart";case 4:case 5:return"lineChart"}}function l(a,b,c,d){switch(k(a)){case"columnChart":return d?j(b,c):i(b);case"lineChart":return d?g(c):f()}}var m,n=angular.extend;return m={getChartType:k,getOptions:l}}]),angular.module("negawattClientApp").service("ChartUsagePeriod",["Utils","Period","Chart","moment","$injector","$stateParams","$state",function(a,b,c,d,e,f,g){function h(){var a={chartFreq:+k.activeTimeFrame.type,chartNextPeriod:k.next||void 0,chartPreviousPeriod:k.previous||void 0};j(f,a),g.refreshUrlWith(f)}function i(){angular.extend(k,{max:null,min:null,next:null,previous:null,chart:null})}var j=angular.extend;j(this,c);var k=(angular.copy,j({},b));this.stateParams=f,this.reset=i,this.config=function(a){k.setLimits(a),k.setTimeFrame(this.getActiveFrequency()),k.setPeriod(a),h()},this.getChartPeriod=function(){return k},this.changePeriod=function(a){"next"==a?k.goNextPeriod():k.goPreviousPeriod(),h()},this.changeFrequency=function(a){i(),this.setActiveFrequency(a),k.setTimeFrame(this.getActiveFrequency()),k.previous=void 0,k.next=void 0,h()},this.setReferenceDate=function(a){k.setPeriod({newDate:a}),h()},this.getReferenceDate=function(){return k.referenceDate},this.hasPeriod=function(a){return"next"===a?!getNewPeriod(a).isLast():"previous"===a?!getNewPeriod(a).isFirst():void 0}}]),angular.module("negawattClientApp").service("ChartCategories",["$q","$filter","Utils","Chart",function(a,b,c,d){function e(a,b){var c=g(a,b);return a.type="PieChart",a.data={cols:[{id:"t",label:"Categories",type:"string"},{id:"s",label:"Slices",type:"number"}],rows:f(a,c)},a}function f(a,d){var e=[];return a=b("filter")(c.toArray(a),function(a){return a.meters>0&&a.depth===d?a:void 0}),angular.forEach(a,function(a){this.push({c:[{v:a.label},{v:a.meters},{id:a.id}]})},e),e}function g(a,b){var c=0;return angular.isDefined(b)&&a&&(c=a[0].depth),c}this.get=function(f,g,h){var i=a.defer();return angular.isDefined(g)&&(h=b("filter")(c.toArray(h),{id:parseInt(g)},!0).pop().children),i.resolve(h?e(angular.copy(h),g):d),i.promise},this.getCategoryIdSelected=function(a,b){return b.rows[a.row].c[2].id}}]),angular.module("negawattClientApp").service("Electricity",["$q","$http","$timeout","$rootScope","Config","Utils","FilterFactory",function(a,b,c,d,e,f,g){function h(c,d,f){var k=a.defer(),l=e.backend+"/api/electricity",m=g.getElectricity(c)||{};return d&&(m.page=d),b({method:"GET",url:l,params:m}).success(function(a,b,e,g){var l=angular.isDefined(g.params.nodata),m=void 0!=a.next;i(a,c,f,l),k.resolve(j(c)),m&&!l&&h(c,d+1,!0)}),k.promise}function i(a,b,d,e){l[b]={data:(l[b]?l[b].data:[]).concat(a.data),limits:a.summary.timestamp,timestamp:new Date,noData:e,summary:a.summary},d||m.push(c(function(){angular.isDefined(l[b])&&(l[b]=void 0)},18e5))}function j(a){var b=angular.isUndefined(a)?l:l[a];return b&&d.$broadcast(o,b),b}var k=this,l={};this.__cache=l;var m=[],n={},o="nwElectricityChanged";this.get=function(b){return angular.isUndefined(b)?void 0:(n[b]=a.when(n[b]||j(b)||h(b,1,!1)),n[b]["finally"](function(){n[b]=void 0}),n[b])},this.refresh=function(a){angular.isUndefined(l[a])&&k.get(a),angular.isDefined(l[a])&&d.$broadcast(o,j(a))},this.forceResolve=function(a){angular.isUndefined(l[a])&&k.get(a)},d.$on("nwClearCache",function(){l={},angular.forEach(m,function(a){c.cancel(a)}),m=[]})}]),angular.module("negawattClientApp").factory("IconFactory",["$injector","$q",function(a,b){function c(a){angular.forEach(a.list,function(a){angular.isDefined(this[a.icon])||(this[a.icon]={unselect:e(a.icon+"-blue.png",h),select:e(a.icon+"-red.png",h)})},this)}function d(c,d){var e=this,f=b.defer(),g=a.get("SiteCategory");return g.get().then(function(a){e.__createIcons(a),f.resolve(e[c][d])}),f.promise}function e(a,b){return{iconUrl:"../images/markers/"+a,shadowUrl:"../images/shadow.png",iconSize:[32,32],shadowSize:[20,20],iconAnchor:[16,29],shadowAnchor:[10,12],popupAnchor:[0,-25],className:f(b),setOptions:g}}function f(a){var b="";return a&&a.hasOwnProperty("transparent")&&a.transparent&&(b="leaflet-marker-icon-transparent"),b}function g(a){this.className=f(a)}var h,i={"default":{unselect:e("marker-blue.png"),select:e("marker-red.png")},getIcon:d,__createIcons:c};return i}]),angular.module("negawattClientApp").service("Map",["$rootScope","$log","leafletData","leafletHelpers",function(a,b,c,d){function e(){return c.getMap().then(function(a){var b;b=a.getBounds().pad(1.2),i={northEast:b._northEast,southWest:b._southWest}})}var f=this,g={},h="nwMapChanged",i={};d.LeafletActiveAreaPlugin.isLoaded()||b.error("[AngularJS - Leaflet] The Leaflet-active-area is not loaded."),this.getMaxBounds=function(){return i},this.getConfig=function(){return{tileLayer:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",zoomControlPosition:"bottomleft",minZoom:12,maxZoom:19,maxNativeZoom:null,fadeAnimation:!1,zoomAnimation:!1,markerZoomAnimation:!1}},this.setCenter=function(b){g.center=angular.extend(g.center||{},b),a.$broadcast(h)},this.updateCenterZoom=function(a){angular.isDefined(g.center)&&(g.center.zoom=a)},this.getCenter=function(a){return angular.isUndefined(g.center)&&angular.isDefined(a.center)&&f.setCenter(a.center),angular.copy(g.center)},this.centerMapByMarker=function(a){c.getMap().then(function(b){f.setCenter(a.getPosition()),b.setView(f.getCenter())})},this.setMarkerSelected=function(a){g.markerSelected=a},this.getMarkerSelected=function(){return g.markerSelected},a.$on("nwClearCache",function(){g={}}),a.$on("leafletDirectiveMap.load",function(a,b){angular.isDefined(b.model.maxbounds)||(e().then(function(){b.model.maxbounds=f.getMaxBounds()}),a.preventDefault())})}]),angular.module("negawattClientApp").factory("Marker",["$injector","$state","$q","$timeout","Map","IconFactory","FilterFactory",function(a,b,c,d,e,f,g){function h(){var a=this.site_categories&&Object.keys(this.site_categories)[0];return a&&this.site_categories[a].name||"default"}function i(){return n}function j(){var a=this;m(this.getCategory(),"unselect").then(function(b){a.icon=b})}function k(){var a=this;angular.isDefined(n)&&n.unselect(),g.setMeterSelected(this),m(this.getCategory(),"select").then(function(b){a.icon=b})}function l(){return{lat:this.lat,lng:this.lng}}function m(a,b){var d=f[a]&&f[a][b]||f.getIcon(a,b);return c.when(d)}var n=g.getMeterSelected();return{icon:{},getCategory:h,getSelected:i,unselect:j,select:k,getPosition:l}}]),angular.module("negawattClientApp").service("Meter",["$q","$http","$timeout","$rootScope","$filter","Config","Marker","Utils","FilterFactory",function(a,b,c,d,e,f,g,h,i){function j(c,d){var e,g=a.defer();return d=d||1,e=f.backend+"/api/meters?&filter[account]="+c+"&page="+d,b({method:"GET",url:e,transformResponse:m}).success(function(a){var b=!!a.next;k(a.data,b),g.resolve(n()),b&&(r=!0,j(c,o(a.next.href))),l()}),g.promise}function k(a,b){var c;angular.isUndefined(q.data)&&(q.data={listAll:{},list:{},summary:{},loaded:null}),angular.extend(q.data.listAll,a&&a.list),angular.extend(q.data.summary,a&&a.summary),q.data.loaded=!b,q.timestamp=new Date,d.$broadcast(s,n()),c=e("meterById")(q.data.listAll,i.get("meter")),!h.isEmpty(c)&&c.has_electricity&&d.$broadcast("activeMeter",c),r=!1}function l(){r||c(function(){q.data=void 0},36e5)}function m(a){var b={};return a=angular.fromJson(a),b={data:{list:h.indexById(a.data)},next:a.next},angular.forEach(b.data.list,function(a){b.data.list[a.id]=a,a.location&&(b.data.list[a.id].lat=parseFloat(a.location.lat),b.data.list[a.id].lng=parseFloat(a.location.lng),delete a.location),b.data.list[a.id].message=(a.image?'<img src="'+a.image.url+'"><br>':"")+a.place_description+"<br>"+a.place_address+"<br>"+a.place_locality,angular.extend(b.data.list[a.id],g),b.data.list[a.id].unselect()}),b.data.summary=a.summary,b}function n(){return angular.isDefined(q.data)&&(q.data.list=i.isDefine("category")||i.isDefine("meter")?q.data.listAll:i.byCategoryFilters(q.data)),q.data}function o(a){var b=/.*page=([0-9]*)/;return b.exec(a).pop()}var p,q={},r=!1,s="nwMetersChanged";this.get=function(b,c){return p=a.when(p||n()||j(b)),angular.isDefined(c)&&i.set("category",c),p["finally"](function(){p=void 0}),p},this.refresh=function(){d.$broadcast(s,n())},d.$on("nwClearCache",function(){q={}})}]),angular.module("negawattClientApp").service("MeterCategory",["$q","$http","$timeout","$state","$rootScope","$filter","Config","Utils","Meter","FilterFactory",function(a,b,c,d,e,f,g,h,i,j){function k(c){var d=a.defer(),e=g.backend+"/api/meter_categories",f={account:c};return b({method:"GET",url:e,params:f,cache:!0,transformResponse:s}).success(function(a){d.resolve(a.data)}),d.promise}function l(b,c){var d=a.defer();return b.then(function(a){a=a,a.collection=f("filter")(h.toArray(a.collection),{id:parseInt(c)},!0).pop().children,d.resolve(a)}),d.promise}function m(a){v={data:a,timestamp:new Date},c(function(){v.data=void 0},36e5),e.$broadcast(w)}function n(b,c){var d=a.defer();return i.get(c).then(function(a){u.meters=h.toArray(a.listAll),b.then(o).then(function(a){m(a),d.resolve(r())})}),d.promise;
}function o(b){var c=a.defer(),d={};return d.list=b,d.collection=h.indexById(b),d.tree=p(b),c.resolve(d),c.promise}function p(a){var b;return a=q(a),b=f("filter")(a,{depth:0})}function q(a){var b=h.indexById(a),c=[];return angular.forEach(a,function(a){angular.forEach(a.children,function(c,d){angular.isString(c)&&(a.children[d]=b[c])}),this.push(a)},c),a}function r(){return angular.isDefined(v.data)&&(v.data.tree=j.refreshCategoriesFilters(v.data.tree)),v.data}function s(a){a=angular.fromJson(a);var b=a.data;return angular.forEach(b,function(a,c){b[c]=angular.extend(a,{checked:!0,indeterminate:!1})}),a.data=b,a}var t,u=this,v={},w="nwMeterCategoriesChanged";this.get=function(b,c){return t=a.when(t||r()||k(b)),t=n(t,b),angular.isDefined(c)&&(t=l(t,c)),t["finally"](function(){t=void 0}),t},this.reset=function(){j.setCategories(r())},e.$on("nwClearCache",function(){v={}})}]),angular.module("negawattClientApp").service("Site",["$q","$http","$timeout","$rootScope","$filter","Config","Marker","Utils","FilterFactory",function(a,b,c,d,e,f,g,h,i){function j(c,d){var e,g=a.defer();return d=d||1,e=f.backend+"/api/sites?&filter[account]="+c+"&page="+d,b({method:"GET",url:e,transformResponse:m}).success(function(a){var b=!!a.next;k(a.data,b),g.resolve(n()),b&&(r=!0,j(c,o(a.next.href))),l()}),g.promise}function k(a,b){var c;angular.isUndefined(q.data)&&(q.data={listAll:{},list:{},summary:{},loaded:null}),angular.extend(q.data.listAll,a&&a.list),angular.extend(q.data.summary,a&&a.summary),q.data.loaded=!b,q.timestamp=new Date,d.$broadcast(s,n()),c=e("siteById")(q.data.listAll,i.get("site")),!h.isEmpty(c)&&c.has_electricity&&d.$broadcast("activeSite",c),r=!1}function l(){r||c(function(){q.data=void 0},36e5)}function m(a){var b={};return a=angular.fromJson(a),b={data:{list:h.indexById(a.data)},next:a.next},angular.forEach(b.data.list,function(a){b.data.list[a.id]=a,a.location&&(b.data.list[a.id].lat=parseFloat(a.location.lat),b.data.list[a.id].lng=parseFloat(a.location.lng),delete a.location);var c=a.image?'<img src="'+a.image.url+'"><br>':"";b.data.list[a.id].message=c+a.place_description+"<br>"+a.place_address+"<br>"+a.place_locality,angular.extend(b.data.list[a.id],g),b.data.list[a.id].unselect()}),b.data.summary=a.summary,b}function n(){return angular.isDefined(q.data)&&(q.data.list=i.isDefine("category")||i.isDefine("site")?q.data.listAll:i.byCategoryFilters(q.data)),q.data}function o(a){var b=/.*page=([0-9]*)/;return b.exec(a).pop()}var p,q={},r=!1,s="nwSitesChanged";this.properties={},this.get=function(b,c){return p=a.when(p||n()||j(b)),angular.isDefined(c)&&i.set("category",c),p["finally"](function(){p=void 0}),p},this.refresh=function(){d.$broadcast(s,n())},d.$on("nwClearCache",function(){q={}})}]),angular.module("negawattClientApp").service("SiteCategory",["$q","$http","$timeout","$state","$rootScope","$filter","Config","Utils","Site","Meter","FilterFactory",function(a,b,c,d,e,f,g,h,i,j,k){function l(c){var d=a.defer(),e=g.backend+"/api/site_categories",f={account:c};return b({method:"GET",url:e,params:f,cache:!0,transformResponse:x}).success(function(a){d.resolve(a.data)}),d.promise}function m(b,c){var d=a.defer();return b.then(function(a){a=a,a.collection=f("filter")(h.toArray(a.collection),{id:parseInt(c)},!0).pop().children,d.resolve(a)}),d.promise}function n(a){A={data:a,timestamp:new Date},c(function(){A.data=void 0},36e5),e.$broadcast(B)}function o(b,c){var d=a.defer();return i.get(c).then(function(a){z.sites=h.toArray(a.listAll),b.then(p).then(q).then(r).then(function(a){n(a),d.resolve(w())})}),d.promise}function p(b){var c=a.defer(),d=angular.isArray(b)?b:b.list;angular.forEach(d,function(a){a.parent=null},d),z.indexed=h.indexById(d);var e=Object.keys(z.indexed);return angular.forEach(e,function(a){angular.forEach(z.indexed[a].children,function(b){"object"==typeof b&&(b=b.id),z.indexed[b].parent=a})}),c.resolve(d),c.promise}function q(b){var c=a.defer(),d=angular.isArray(b)?b:b.list;angular.forEach(d,function(a){a.numberOfSites=0},d);var e={};return angular.forEach(d,function(a){e[a.id]=a.sites.length}),angular.forEach(e,function(a,b){if(a)for(;b;){var c=z.indexed[b];c&&(c.numberOfSites+=a,b=c.parent)}}),d=h.toArray(z.indexed),c.resolve(d),c.promise}function r(b){var c=a.defer(),d={};return d.list=b,d.collection=h.indexById(b),d.tree=s(b),c.resolve(d),c.promise}function s(a){var b;return a=v(a),b=f("filter")(a,{depth:0})}function t(a,b){a.meters&&a.meters.indexOf(b)>=0||(a.meters||(a.meters=[]),a.meters.push(b))}function u(a,b){for(var c in a.children){var d=a.children[c];if(d.isSite&&d.id==b.id)return}a.children.push({id:b.id,label:b.label,meters:b.meters,isSite:!0}),a.numberOfSites++}function v(a){var b=h.indexById(a),c=h.indexById(z.sites),d=[];return angular.forEach(a,function(a){angular.forEach(a.children,function(c,d){"object"!=typeof c&&(a.children[d]=b[c])}),angular.forEach(a.sites,function(b){if("undefined"!=typeof c[b]){var d=c[b];if(!d.meters||0==d.meters.length)return;1==d.meters.length?t(a,d.meters[0]):u(a,d)}}),this.push(a)},d),a}function w(){return angular.isDefined(A.data)&&(A.data.tree=k.refreshCategoriesFilters(A.data.tree)),A.data}function x(a){a=angular.fromJson(a);var b=a.data;return angular.forEach(b,function(a,c){b[c]=angular.extend(a,{checked:!0,indeterminate:!1})}),a.data=b,a}var y,z=this,A={},B="nwSiteCategoriesChanged";this.get=function(b,c){return y=a.when(y||w()||l(b)),y=o(y,b),angular.isDefined(c)&&(y=m(y,c)),y["finally"](function(){y=void 0}),y},this.reset=function(){k.setCategories(w())},e.$on("nwClearCache",function(){A={}})}]),angular.module("negawattClientApp").factory("FilterFactory",["$filter","$state","$stateParams","$rootScope","$injector","Utils",function(a,b,c,d,e,f){function g(a){var b;return b={"filter[meter]":a.climate,"filter[frequency]":a.chartFreq,"filter[timestamp][operator]":"BETWEEN","filter[timestamp][value][0]":a.chartPreviousPeriod||"","filter[timestamp][value][1]":a.chartNextPeriod||""}}function h(a){return angular.extend(a,{selectorType:a.sel,selectorId:a.ids&&a.ids.split(","),multipleGraphs:i}),j(a)}function i(){return angular.isArray(this.selectorId)}function j(a){var b=e.get("FilterFactory"),c={"filter[meter_account]":a.accountId,"filter[frequency]":a.chartFreq};if(a.noData?(angular.extend(c,{nodata:1}),b.set("electricity-nodata",!0)):(angular.extend(c,{"filter[timestamp][operator]":"BETWEEN","filter[timestamp][value][0]":a.chartPreviousPeriod||"","filter[timestamp][value][1]":a.chartNextPeriod||""}),b.set("electricity-nodata",!1)),a.selectorType)if(a.multipleGraphs()){c["filter["+a.selectorType+"][operator]"]="IN";var d=0;angular.forEach(a.selectorId,function(b){c["filter["+a.selectorType+"][value]["+d++ +"]"]=b})}else c["filter["+a.selectorType+"]"]=a.selectorId;return c}function k(a){a.getCategoryFilter=q,angular.forEach(a,function(a){a.children&&k(a.children)})}function l(a){return a.tree||a}function m(b){var c;return b=angular.copy(b),angular.isNumber(b[0].meters)&&(b=b.map(function(a){return a.meters=a.meters.toString(),a})),b=a("filter")(b,{meters:"!0"},!0),angular.forEach(b,function(a){c=c!==a.checked&&angular.isDefined(c)||"indeterminate"===c?"indeterminate":a.checked}),c}function n(a){var b=o.bind(e.get("FilterFactory"),a)();return b?p(b):!1}function o(a,b){var c;return b=b||this.get("categories"),angular.forEach(b,function(b){b.id===a&&(c=b.children),b.children&&(c=c||o(a,b.children))}),c}function p(a){var b,c=0;return angular.forEach(a,function(a){a.checked!==b&&(b=a.checked,c++)}),1!==c&&a.length>1?!0:!1}function q(a){var b;return angular.forEach(this,function(c){c.id===a&&(b=c),c.children&&angular.isUndefined(b)&&(b=c.children.getCategoryFilter(a))}),b}function r(a){var b=[],a=a||this.get("categories");return angular.forEach(a,function(a){a.checked&&b.push(a.id),a.children&&(b=b.concat(r(a.children)))}),b}function s(a,b){return b=b||this,angular.forEach(b,function(c,d){var e,f=a.getCategoryFilter(c.id);angular.isDefined(f)&&(angular.extend(b[d],f,{meters:c.meters,children:c.children}),b[d].indeterminate=n(c.id),c.children&&c.children.length&&(e=m(c.children),"indeterminate"!==e&&(b[d].checked=e,b[d].indeterminate=!1))),c.children&&(b[d].children=s(a,c.children))}),b}return{filters:{},updateSelection:function(a,d){c.sel=a,c.ids=d,b.refreshUrlWith(c),this.setElectricity(c)},addObjectSelected:function(a,b){var d=!0;if(a.selected){c.sel=b;var e=c.ids?c.ids.split(","):[];e.push(a.id),c.ids=e.join()}else{var e=c.ids.split(",");e.splice(e.indexOf(""+a.id),1),c.ids=e.join(),""==c.ids&&(c.sel=void 0,d=!1)}return this.updateSelection(c.sel,c.ids),d},addMeterSelected:function(a){return this.addObjectSelected(a,"meter")},addSiteCategorySelected:function(a){return this.addObjectSelected(a,"site_category")},addSiteSelected:function(a){return this.addObjectSelected(a,"meter_site")},addClimateSelected:function(a){var d=!0;if(a.selected){var e=c.climate?c.climate.split(","):[];e.push(a.id),c.climate=e.join()}else{var e=c.climate.split(",");e.splice(e.indexOf(""+a.id),1),c.climate=e.join(),""==c.climate&&(d=!1)}return b.refreshUrlWith(c),this.setTemperature(c),d},byCategoryFilters:function(b){return b=f.toArray(b.listAll),b=a("filterMeterByCategories")(b,r.bind(this)(),this.isDefine("categories"))},showCategoryFilters:function(){var a=!1;return b.is("dashboard.withAccount")&&(a=!0),a},clear:function(){this.clearMeterSelection(),c.chartNextPeriod=void 0,c.chartPreviousPeriod=void 0,this.filters={}},getMeterSelected:function(){return this.filters.meterSelected||void 0},setMeterSelected:function(a){this.filters.meterSelected=a},clearMeterSelection:function(){angular.isDefined(this.filters.meterSelected)&&this.filters.meterSelected.unselect(),this.filters.meterSelected=void 0,this.filters.meter=void 0},refreshCategoriesFilters:function(a){var b=this.get("categories");return a.$$extendWithFilter=s,b&&a.$$extendWithFilter(b)||a},getElectricity:function(a){return this.filters.electricity&&this.filters.electricity[a]},getTemperature:function(a){return this.filters.temperature&&this.filters.temperature[a]},isDefine:function(a){var b=!!this.filters[a];return angular.isArray(this.filters[a])&&(b=!!this.filters[a].length),b},set:function(a,b){b=angular.copy(b),this.filters[a]=b},get:function(a){return this.filters&&this.filters[a]},setElectricity:function(a){var b=h(a),c=f.objToHash(b);this.set("activeElectricityHash",c),b=f.cleanProperties(b),this.filters.electricity=angular.isUndefined(this.filters.electricity)?{}:this.filters.electricity,this.filters.electricity[this.get("activeElectricityHash")]=b},setCategories:function(a){var b=l(a);this.filters.categories=b,k(this.filters.categories)},setTemperature:function(a){if(!a.climate)return this.set("activeTemperatureHash",void 0),void(this.filters.temperature={});var b=g(a),c=f.objToHash(b);this.set("activeTemperatureHash",c),b=f.cleanProperties(b),this.filters.temperature=angular.isUndefined(this.filters.temperature)?{}:this.filters.temperature,this.filters.temperature[this.get("activeTemperatureHash")]=b}}}]),angular.module("negawattClientApp").service("Message",["$q","$http","$rootScope","$state","$timeout","$sce","Config","moment",function(a,b,c,d,e,f,g,h){function i(c){var d=a.defer(),e=g.backend+"/api/notifications?sort=-timestamp&filter[meter_account]="+c.id;return b({method:"GET",url:e,transformResponse:j,cache:!0}).success(function(a){k(a),d.resolve(l.data)}),d.promise}function j(a){var b=angular.fromJson(a).data;return angular.forEach(b,function(a){a.date=h.unix(a.timestamp).format("YYYY-MM"),a.text=!!a.description&&a.description||!!a.address&&a.address||!!a.title&&a.title||""}),b}function k(a){l={data:a,timestamp:new Date},e(function(){l.data=void 0},6e4),c.$broadcast(m)}var l={},m="nwMessagesChanged";this.get=function(b){return a.when(l.data||i(b))},c.$on("nwClearCache",function(){l={}})}]),angular.module("negawattClientApp").service("Profile",["$q","$http","$timeout","$state","$rootScope","Config",function(a,b,c,d,e,f){function g(){var b,c=a.defer();return b=a.all([h(),i()]),b.then(function(a){j(a),c.resolve(m.data)}),c.promise}function h(){var a=f.backend+"/api/me";return b({method:"GET",url:a,transformResponse:k})}function i(){var a=f.backend+"/api/accounts";return b({method:"GET",url:a,transformResponse:l})}function j(a){m={data:{user:a[0].data,account:a[1].data},timestamp:new Date},c(function(){m.data=void 0},36e5),e.$broadcast(n)}function k(a){return angular.fromJson(a).data}function l(a){if(a){var b=angular.fromJson(a);if(b)return angular.forEach(b.data,function(a,b){a.center={lat:parseFloat(a.location.lat),lng:parseFloat(a.location.lng),zoom:parseInt(a.zoom)},delete a.location,delete a.zoom}),b.data}}var m={},n="nwProfileChanged";this.get=function(){return a.when(m.data||g())},this.selectAccount=function(a,b){return a=+a,(angular.isUndefined(b.active)||b.active.id!==a)&&(b.active=b.account.filter(function(b){return b.id==a}).pop(),e.$broadcast("nwClearCache")),b.active},e.$on("nwClearCache",function(){m={}})}]),angular.module("negawattClientApp").service("PropertyMeter",["$q","$http","$timeout","$rootScope","$filter","Config","Utils","FilterFactory",function(a,b,c,d,e,f,g,h){function i(c,d){var e,g=a.defer();return d=d||1,e=f.backend+"/api/property_meters?&filter[account]="+c+"&page="+d,b({method:"GET",url:e}).success(function(a){var b=!!a.next;j(a.data,b),g.resolve(l()),b&&(p=!0,i(c,m(a.next.href))),k()}),g.promise}function j(a,b){var c;angular.isUndefined(o.data)&&(o.data={listAll:{},list:{},summary:{},loaded:null}),angular.extend(o.data.listAll,a),o.data.loaded=!b,o.timestamp=new Date,d.$broadcast(q,l()),c=e("meterById")(o.data.listAll,h.get("meter")),!g.isEmpty(c)&&c.has_electricity&&d.$broadcast("activePropertyMeter",c),p=!1}function k(){p||c(function(){o.data=void 0},36e5)}function l(){return angular.isDefined(o.data)&&(o.data.list=h.isDefine("category")||h.isDefine("meter")?o.data.listAll:h.byCategoryFilters(o.data)),o.data}function m(a){var b=/.*page=([0-9]*)/;return b.exec(a).pop()}var n,o={},p=!1,q="nwPropertyMetersChanged";this.get=function(b){return n=a.when(n||l()||i(b)),n["finally"](function(){n=void 0}),n},this.refresh=function(){d.$broadcast(q,l())},d.$on("nwClearCache",function(){o={}})}]),angular.module("negawattClientApp").factory("Period",["$injector","moment","Utils",function(a,b,c){return{max:null,min:null,next:null,previous:null,activeTimeFrame:null,referenceDate:b().unix(),isConfigured:function(){return!!this.max&&!!this.min},getReferenceDate:function(){return this.referenceDate},setTimeFrame:function(a){this.activeTimeFrame=a},setLimits:function(a){this.max=a&&+a.max||null,this.min=a&&+a.min||null},setPeriod:function(a){a&&a.newDate&&(this.referenceDate=a.newDate),this.isOutOfRange(this.referenceDate)&&(this.referenceDate=this.putInRange(this.referenceDate));var b=this.activeTimeFrame.get_period(this.referenceDate);this.previous=b.from,this.next=b.to},isLast:function(){return this.isOutOfRange(this.next)},isFirst:function(){return this.isOutOfRange(this.previous-1)},goNextPeriod:function(){this.referenceDate=this.activeTimeFrame.getNextTimestamp?this.activeTimeFrame.getNextTimestamp():this.next,this.setPeriod()},goPreviousPeriod:function(){this.referenceDate=this.activeTimeFrame.getPreviousTimestamp?this.activeTimeFrame.getPreviousTimestamp():this.previous-1,this.setPeriod()},isOutOfRange:function(a){return!a||this.max&&a>this.max||this.min&&a<this.min},putInRange:function(a){return this.max&&a>this.max?this.max:this.min&&a<this.min?this.min:a},add:function(a){return b.unix(a).add(this.activeTimeFrame&&this.activeTimeFrame.chart_default_time_frame,this.activeTimeFrame&&this.activeTimeFrame.frequency)},subtract:function(a){return b.unix(a).subtract(this.activeTimeFrame&&this.activeTimeFrame.chart_default_time_frame,this.activeTimeFrame&&this.activeTimeFrame.frequency)}}}]),angular.module("negawattClientApp").service("Utils",["md5",function(a){var b=this;this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var c,d,e,f,g,h,i,j="",k=0;for(a=b.Base64._utf8_encode(a);k<a.length;)c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=a.charCodeAt(k++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),j=j+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}},this.indexById=function(a){var b={};return angular.forEach(a,function(a){this[a.id]=a},b),b},this.toArray=function(a){var b=[];return angular.forEach(a,function(a){this.push(a)},b),b},this.objToHash=function(b){return b&&a.createHash(JSON.stringify(b))},this.cleanProperties=function(a){return angular.forEach(a,function(b,c){angular.isUndefined(b)&&delete a[c]}),a},this.isEmpty=function(a){return angular.isUndefined(a)||null===a||angular.isObject(a)&&!Object.keys(a).length}}]),angular.module("negawattClientApp").factory("Timedate",["$interval",function(a){var b={today:new Date,now:null,startClock:function(){var b=this;a(function(){b.now=new Date},1e3)}};return b.startClock(),b}]),angular.module("negawattClientApp").service("Temperature",["$q","$http","$timeout","$rootScope","Config","Utils","FilterFactory",function(a,b,c,d,e,f,g){function h(c,d,f){var k=a.defer(),l=e.backend+"/api/climate",m=g.getTemperature(c)||{};return d&&(m.page=d),b({method:"GET",url:l,params:m}).success(function(a,b,e,g){var l=angular.isDefined(g.params.nodata),m=void 0!=a.next;i(a,c,f,l),k.resolve(j(c)),m&&!l&&h(c,d+1,!0)}),k.promise}function i(a,b,e){k[b]={data:(k[b]?k[b].data:[]).concat(a.data)},d.$broadcast(n,j(b)),e||l.push(c(function(){angular.isDefined(k[b])&&(k[b]=void 0)},18e5))}function j(a){return angular.isUndefined(a)?k:k[a]&&k[a].data}var k={};this.__cache=k;var l=[],m={},n="nwTemperatureChanged";this.get=function(b){return angular.isUndefined(b)?a.when({}):(m[b]=a.when(m[b]||j(b)||h(b,1,!1)),m[b]["finally"](function(){m[b]=void 0}),m[b])},d.$on("nwClearCache",function(){k={},angular.forEach(l,function(a){c.cancel(a)}),l=[]})}]),angular.module("negawattClientApp").filter("activeElectricityFilters",["FilterFactory",function(a){function b(a,b){return angular.isUndefined(b)?a.data:a[b]}return function(c,d){var e=a.get("activeElectricityHash");return angular.isDefined(c[e])?b(c[e],d):void 0}}]),angular.module("negawattClientApp").filter("toPieChartDataset",["Utils","$filter",function(a,b){function c(a){return{pieSliceText:"label",tooltip:{isHtml:!0},legend:{position:"top",maxLines:5},backgroundColor:"none"}}function d(a,b){var c;switch(a.type){case"site_categories":c="קטגוריה";break;case"sites":c="אתר";break;case"meters":c="מונה"}var d={cols:[{label:c,type:"string"},{label:'קוט"ש',type:"number"}],rows:e(a.values,a.type,b)};return d}function e(c,d,e){var f,g,h=[];switch(d){case"site_categories":f="Category ",g="site_category";break;case"sites":f="Site ",g="site";break;case"meters":f="Meter ",g="meter"}return angular.forEach(c,function(c,d){this.push({c:[{v:!a.isEmpty(e)&&e[d].label||f+d},{v:+c,f:b("number")(c,0)+" קוט״ש"},{id:d},{onSelect:{sel:g,ids:d}}]})},h),h}return function(a,b){return a={type:"PieChart",data:d(a,b),options:c(a.type)}}}]),angular.module("negawattClientApp").filter("toChartDataset",["$filter","Chart","ChartOptions","moment","$window",function(a,b,c,d,e){function f(a,b,c,d,e,f,i){var j=[],k={rows:g(a,b,c,j,e,f,i),cols:h(a,b,c,j,d,f),numSeries:j.length};return k}function g(b,e,f,g,h,j,k){var l,m,n={},o=[],p=i(e),q={};if(j&&angular.forEach(j,function(a){q[a.timestamp]=a}),"sum"==f){m="lineChart"==c.getChartType(e.type),angular.forEach(b,function(a){a.timestamp_rounded in n||(n[a.timestamp_rounded]={}),n[a.timestamp_rounded][a.rate_type]||(n[a.timestamp_rounded][a.rate_type]=0),n[a.timestamp_rounded][a.rate_type]+=+a[p],m&&l&&l!=a.rate_type&&(n[a.timestamp_rounded][l]||(n[a.timestamp_rounded][l]=0),n[a.timestamp_rounded][l]+=+a[p]),l=a.rate_type});var r=-1!=["hour","minute"].indexOf(e.frequency)?"קו״ט":"קוט״ש";angular.forEach(n,function(b,c){var f=d.unix(c).toDate(),g=d.unix(c).format(e.tooltip_format),h=[{v:f}];if(["flat","peak","mid","low"].forEach(function(c){var d=b[c];h.push({v:d}),h.push(d?{v:g+"\n"+a("number")(b[c],0)+" "+r}:{})}),j){var i=q[c]?q[c][k]:void 0;h.push(i?{v:i}:{}),h.push(i?{v:g+"\n"+a("number")(i,0)+" מעלות"}:{})}o.push({c:h,onSelect:c})})}else if("detailed"==f||"stacked"==f){angular.forEach(b,function(a){a.timestamp_rounded in n||(n[a.timestamp_rounded]={}),-1==g.indexOf(+a[h])&&g.push(+a[h]),n[a.timestamp_rounded][a[h]]||(n[a.timestamp_rounded][a[h]]=0),n[a.timestamp_rounded][a[h]]+=+a[p]});var r=-1!=["hour","minute"].indexOf(e.frequency)?"קו״ט":"קוט״ש";angular.forEach(n,function(b,c){var f=d.unix(c).toDate(),h=d.unix(c).format(e.tooltip_format),i=[{v:f}];if(g.forEach(function(c){var d=b[c];i.push({v:d}),i.push(d?{v:h+"\n"+a("number")(b[c],0)+" "+r}:{})}),j){var l=q[c]?q[c][k]:void 0;i.push(l?{v:l}:{}),i.push(l?{v:h+"\n"+a("number")(l,0)+" מעלות"}:{})}o.push({c:i,onSelect:c})})}return o}function h(a,b,c,d,e,f){if("sum"==c){var g=[{id:"month",label:"Month",type:"date"},{id:"flat",label:"אחיד",type:"number"},{id:"flat",type:"string",p:{role:"tooltip"}},{id:"peak",label:"פסגה",type:"number"},{id:"peak",type:"string",p:{role:"tooltip"}},{id:"mid",label:"גבע",type:"number"},{id:"mid",type:"string",p:{role:"tooltip"}},{id:"low",label:"שפל",type:"number"},{id:"low",type:"string",p:{role:"tooltip"}}];return f&&g.push({id:"temp",label:"טמפרטורה",type:"number"},{id:"temp",type:"string",p:{role:"tooltip"}}),g}if("detailed"==c||"stacked"==c){var g=[{id:"month",label:"Month",type:"date"}];return d.forEach(function(a){g.push({id:a,label:e[a].label,type:"number"},{id:a,type:"string",p:{role:"tooltip"}})}),f&&g.push({id:"temp",label:"טמפרטורה",type:"number"},{id:"temp",type:"string",p:{role:"tooltip"}}),g}}function i(a){return a=+a.type,-1!==[1,2,3].indexOf(a)?"kwh":-1!==[4,5].indexOf(a)?"avg_power":void 0}return function(a,d,e,g,h,i,j,k){d=d?d:"stacked","detailed"!=d&&"stacked"!=d||!k||(d="sum");var l=b.getActiveFrequency();if("options-only"==a)return c.getOptions(l,d,!!e);var m=f(a,l,d,h,i,e,j);return g=c.getOptions(l.type,d,m.numSeries,!!e),a={type:g.chart_type,data:m,options:g}}}]),angular.module("negawattClientApp").filter("summary",function(){return function(a){return a&&a.summary||void 0}}),angular.module("negawattClientApp").filter("meterById",["Utils","FilterFactory","$filter",function(a,b,c){return function(b,c){var d;return d=angular.copy(b)[c]||[],!a.isEmpty(d)&&d||{}}}]),angular.module("negawattClientApp").filter("filterMeterByCategories",["Utils","FilterFactory","$filter",function(a,b,c){return function(b,d,e){var f=[];return!d.length&&e&&(b=f),b.length&&d.length&&(angular.isArray(b)||(b=a.toArray(b)),angular.isNumber(d[0])&&(d=d.map(function(a){return a.toString()})),angular.forEach(d,function(a){f=f.concat(c("filter")(b,{meter_categories:{$:{id:a}}},!0))}),b=f),angular.isArray(b)&&(b=a.indexById(b)),b}}]),angular.module("negawattClientApp").filter("metersByActiveCategory",["Utils","FilterFactory","$filter",function(a,b,c){function d(d){return d=a.toArray(d.listAll),a.indexById(c("filter")(d,angular.bind(b,e),!0))}function e(a){return!this.isDefine("category")||a.meter_categories&&a.meter_categories[this.get("category")]?a:void 0}return function(a){return d(a)}}]),angular.module("negawattClientApp").filter("setMetersOptionsByActiveCategory",["Utils","FilterFactory","$filter",function(a,b,c){function d(b,d,f){return b=a.toArray(b),a.indexById(c("filter")(b,angular.bind(null,e,d,f),!0))}function e(b,c,d){var e=angular.bind(d,f,c);return d.icon.setOptions("activeCategory"),!a.isEmpty(d.icon)&&e()&&d.icon.setOptions(b),d}function f(a){var c;switch(a){case void 0:c=!0;break;case"activeCategory":c=!(this.meter_categories&&this.meter_categories[b.get("category")]);break;case"noActiveCategory":c=this.meter_categories&&!this.meter_categories[b.get("category")]}return c||!1}return function(a,b,c){return d(a,b,c)}}]),angular.module("negawattClientApp").filter("siteById",["Utils","FilterFactory","$filter",function(a,b,c){return function(b,c){var d;return d=angular.copy(b)[c]||[],!a.isEmpty(d)&&d||{}}}]),angular.module("negawattClientApp").filter("includedByParams",["$state","$stateParams",function(a,b){var c=function(a,c){return angular.isDefined(b[a])&&b[a]&&+b[a]===c};return c}]),angular.module("negawattClientApp").directive("loadingBarText",function(){return{restrict:"EA",template:'<div class="splash-screen" ng-show="isLoading">{{text}}</div>',controller:["$scope",function(a){function b(b){a.isLoading=b}a.text="טוען...",a.isLoading=!1,a.$on("cfpLoadingBar:started",function(){b(!0)}),a.$on("cfpLoadingBar:completed",function(){b(!1)})}],scope:{}}}),angular.module("negawattClientApp").directive("chartDetailedTabs",function(){return{templateUrl:"scripts/directives/chart-detailed/chart-detailed-tabs.directive.html",controller:["$scope","$rootScope","Chart","$filter","ChartUsagePeriod",function(a,b,c,d,e){var f=this;e.config(),f.frequencies=e.getFrequencies(),f.changeFrequency=function(a){b.$broadcast("nwFrequencyChanged",a),b.$broadcast("nwChartBeginLoading")}}],controllerAs:"ctrlChartTabs"}}).directive("chartDetailedDatePicker",function(){return{scope:{referenceDate:"=",showCompareChart:"=",showCompareChartButton:"="},templateUrl:"scripts/directives/chart-detailed/chart-detailed-date-selector.directive.html",controller:["$scope","$stateParams","$timeout",function(a,b,c){var d=this,e={1:{frequency:1,"datepicker-mode":"'year'","min-mode":"year",format:"yyyy"},2:{frequency:2,"datepicker-mode":"'year'","min-mode":"year",format:"yyyy"},3:{frequency:3,"datepicker-mode":"'month'","min-mode":"month",formatMonth:"MMM",format:"MM/yyyy"},4:{frequency:4,formatMonth:"MMM",showWeeks:!1,format:"dd/MM/yy"},5:{frequency:5,formatMonth:"MMM",showWeeks:!1,format:"dd/MM/yy"}};d.minDate=void 0,d.maxDate=void 0,d.dateOptions=e,d.chartFreq=b.chartFreq,d.open=function(a){c(function(){a.opened=!0})},d.frequencyChanged=function(a){d.chartFreq=a},d.changePeriod=function(b){a.$parent.chart.changePeriod(b)},a.$on("$locationChangeSuccess",function(a){d.frequencyChanged(b.chartFreq)})}],bindToController:!0,controllerAs:"ctrlChartDatePicker"}}).directive("chartDetailed",function(){return{templateUrl:"scripts/directives/chart-detailed/chart-detailed.directive.html",controller:["$scope","$rootScope","$window","$filter","ChartDetailedService","ChartOptions","ChartUsagePeriod","$stateParams",function(a,b,c,d,e,f,g,h){function i(){b.$broadcast("nwChartBeginLoading");var a={accountId:h.accountId,chartFreq:h.chartFreq,chartPreviousPeriod:n.getChartPeriod().previous,chartNextPeriod:n.getChartPeriod().next,sel:h.sel,ids:h.ids,noData:m.checkTimeRange},c={chartFreq:m.frequency,compareWith:m.compareWith};if(k(c),m.dateRange=n.formatDateRange(1e3*n.getChartPeriod().previous,1e3*n.getChartPeriod().next),m.referenceDate=1e3*n.getChartPeriod().referenceDate,m.getElectricity(a),h.climate){var d={climate:h.climate,chartFreq:h.chartFreq,chartPreviousPeriod:n.getChartPeriod().previous,chartNextPeriod:n.getChartPeriod().next};e.getCompareCollection("temperature",d).then(function(a){m.compareCollection=a})}}function j(a){n.changePeriod(a),i()}function k(a){m.options=f.getOptions(a.chartFreq,a.chartType,!!a.compareWith)}function l(){i()}var m=this;angular.extend(m,e),m.electricity={},m.summary={},m.pieOptions={},m.frequency=h.chartFreq,m.account=h.accountId;var n=g;n.config(),m.checkTimeRange=!0,m.filtersChanged=l,m.changePeriod=j,l(),a.$watch("chart.frequency",function(a,b){a!==b&&(m.checkTimeRange=!0,l())},!0),a.$watch("chart.siteProperties",function(a,b){a===b||angular.isUndefined(a)||(m.compareWith=a.compareWith,m.meter=a.meter,i())},!0),a.$on("nwFrequencyChanged",function(a,b){m.checkTimeRange=!0,m.frequency=b.type,n.changeFrequency(b.type),i()}),a.$watch("chart.referenceDate",function(a,b){b!=a&&a!=n.getReferenceDate()&&(n.setReferenceDate(a/1e3),i())}),a.$on("nwElectricityChanged",function(a,b){if(!m.checkTimeRange)return m.electricity=b.data,void(m.summary=b.summary);m.checkTimeRange=!1;var c={min:b.summary.timestamp.min,max:b.summary.timestamp.max};n.config(c),i()}),a.$on("nwTemperatureChanged",function(a,b){m.compareCollection=b}),a.$watch(function(){return c.innerWidth},function(){void 0!=m.data&&(m.data.options=d("toChartDataset")("options-only",h.chartType))},!0)}],controllerAs:"chart",bindToController:!0,scope:{title:"@",siteProperties:"=",categories:"=",hasExtraChart:"=",isCompareChart:"=",chartObject:"="}}}),angular.module("negawattClientApp").service("ChartDetailedService",["$q","FilterFactory","Electricity","Temperature",function(a,b,c,d){function e(d){d&&b.setElectricity(d);var e=c.get(b.get("activeElectricityHash"));return i(e)?a.promise:e}function f(a,b){var c;return"temperature"===a&&(c=g(b)),c}function g(c){c&&b.setTemperature(c);var e=d.get(b.get("activeTemperatureHash")).then(function(a){return h(a,c)});return i(e)?a.promise:e}function h(a,b){if((4==b.chartFreq||5==b.chartFreq)&&(!b.sel||b.sel.split(",").length<2)){var c=void 0,d=void 0,e=4==b.chartFreq?3600:600,f=[];return angular.forEach(a,function(a){var b=a.timestamp_rounded,g=a.avg_temp;if(c)for(var h=(b-c)/e-1,i=(g-d)/(h+1),j=0;h>j;j++)c+=e,d+=i,f.push({timestamp:c,timestamp_rounded:c,avg_temp:d});f.push(a),c=+b,d=+g}),f}return a}var i=angular.isUndefined;this.getElectricity=e,this.getTemperature=g,this.getCompareCollection=f}]),angular.module("negawattClientApp").directive("chartElectricityUsage",function(){return{restrict:"EA",templateUrl:"scripts/directives/chart-electricity-usage/chart-electricity-usage.directive.html",controller:["ChartElectricityUsage","ChartUsagePeriod","$stateParams","$filter","$scope",function(a,b,c,d,e){function f(a){return angular.isDefined(a)?void(m.state=a):void(m.state=h()?"data":"empty")}function g(){return!angular.isUndefined(m.state)}function h(){return m.data.data.rows.length||!1}function i(a){return g()&&h()?b.hasPeriod(a):!1}function j(c){g()&&(b.changePeriod(c),a.requestElectricity(b.stateParams))}function k(c){g()&&(b.changeFrequency(c),a.requestElectricity(b.stateParams))}function l(a){m.data=d("toChartDataset")(a,c.chartType),f()}var m=this;m.frequencies=b.getFrequencies(),m.state="loading",m.showNavigation=i,m.changePeriod=j,m.hasData=h,m.changeFrequency=k,m.messages={empty:b.messages.empty},e.$watch("ctrlChart.electricity",function(a){angular.isUndefined(a)||l(a)},!0)}],controllerAs:"ctrlChart",bindToController:!0,scope:{electricity:"="}}}),angular.module("negawattClientApp").service("ChartElectricityUsage",["FilterFactory","Electricity",function(a,b){function c(c){a.setElectricity(c),b.refresh(a.get("activeElectricityHash"))}this.requestElectricity=c}]),angular.module("negawattClientApp").directive("chartElectricityCompare",function(){return{restrict:"EA",templateUrl:"scripts/directives/chart-electricity-compare/chart-electricity-compare.directive.html",controller:["ChartElectricityUsage","ChartUsagePeriod","$stateParams","$filter","$scope","Utils",function(a,b,c,d,e,f){function g(a){return angular.isDefined(a)?void(n.state=a):void(n.state=i()?"data":"empty")}function h(){return!angular.isUndefined(n.state)}function i(){return n.data.data.rows.length||!1}function j(a){return h()&&i()?b.hasPeriod(a):!1}function k(c){h()&&(b.changePeriod(c),a.requestElectricity(b.stateParams))}function l(c){h()&&(b.changeFrequency(c),a.requestElectricity(b.stateParams))}function m(a,b,f,h){var i=h.type,j=!c.ids||1==c.ids.split(",").length;j&&("site_categories"==i?i="accounts":"sites"==i?i="site_categories":"meters"==i&&(i="sites"));var k,l=e.$parent.$parent,m=l.detailedChartCtrl,o={};switch(i){case"accounts":o[m.account]={label:m.title},k="meter_account";break;case"site_categories":o=l.siteCategories.collection,
k="site_category";break;case"sites":o=l.sites.listAll,k="meter_site";break;case"meters":o=l.meters.listAll,k="meter"}var p="avg_temp";n.data=d("toChartDataset")(a,c.chartType,b,f,o,k,p,j),g()}var n=this;n.frequencies=b.getFrequencies(),n.state="loading",n.showNavigation=j,n.changePeriod=k,n.hasData=i,n.changeFrequency=l,e.onSelect=function(d,e){var f=d.row,g=(d.column,e.data.rows[f].timestamp);b.setReferenceDate(g);var h=c.chartFreq;5>h&&h++,b.changeFrequency(h),a.requestElectricity(b.stateParams)},n.messages={empty:b.messages.empty},e.$watchGroup(["ctrlChart.electricity","ctrlChart.compareCollection","ctrlChart.options","ctrlChart.summary"],function(a){angular.isUndefined(a)||f.isEmpty(a[0])||angular.isUndefined(a[2])||m(a[0],a[1],a[2],a[3])},!0),e.$on("nwChartBeginLoading",function(){g("loading")})}],controllerAs:"ctrlChart",bindToController:!0,scope:{electricity:"=",compareCollection:"=",options:"=",summary:"="}}}),angular.module("negawattClientApp").service("ChartElectricityCompare",["FilterFactory","Electricity",function(a,b){function c(c){a.setElectricity(c),b.refresh(a.get("activeElectricityHash"))}this.requestElectricity=c}]),angular.module("negawattClientApp").directive("chartPieCompare",function(){return{restrict:"EA",templateUrl:"scripts/directives/chart-pie-compare/chart-pie-compare.directive.html",controller:["ChartUsagePeriod","Chart","$stateParams","$filter","$scope","$state","Utils",function(a,b,c,d,e,f,g){function h(a){return angular.isDefined(a)?void(k.state=a):void(k.state=i()?"data":"empty")}function i(){return k.data.data.rows&&k.data.data.rows.length||!1}function j(a,b){var c,f=e.$parent.$parent;switch(a.type){case"site_categories":c=f.siteCategories.collection;break;case"sites":c=f.sites.listAll;break;case"meters":c=f.meters.listAll}k.data=d("toPieChartDataset")(a,c),h()}var k=this;k.state="loading",e.onSelect=function(a,b){var d=a.row,g=b.data.rows[d].c[3].onSelect;c.sel=g.sel,c.ids=g.ids,f.refreshUrlWith(c);var h=e.$parent.chart;h.getElectricity(c)},k.messages={empty:a.messages.empty},e.$watchGroup(["ctrlPieChart.summary","ctrlPieChart.options"],function(a){angular.isUndefined(a)||g.isEmpty(a[0])||angular.isUndefined(a[1])||j(a[0],a[1])},!0),e.$on("nwChartBeginLoading",function(){h("loading")})}],controllerAs:"ctrlPieChart",bindToController:!0,scope:{summary:"=",options:"="}}}),angular.module("negawattClientApp").config(["$provide",function(a){a.decorator("$state",["$delegate","$urlRouter","$location","$stateParams","Utils",function(a,b,c,d,e){var f=(angular.copy,angular.extend),g=(angular.isDefined,angular.isUndefined),h={};return a.go=function(b,c,d){return g(h[b])&&(h[b]={reloadOnSearch:a.$current.reloadOnSearch}),a.$current.reloadOnSearch=h[b].reloadOnSearch,a.transitionTo(b,c,f({inherit:!0,relative:a.$current},d))},a.forceGo=function(b,c,d){return a.current.reloadOnSearch=!0,a.transitionTo(b,c,f({inherit:!0,relative:a.$current},d))},a.setGlobal=function(b,c){if(!angular.isUndefined(a.$current.locals.globals[b])){var d=a.$current.locals;angular.forEach(d,function(a,d){"resolve"!==d&&(a[b]=c)})}},a.refreshUrlWith=function(e){angular.forEach(d,function(a,b){null===a&&delete d[b]}),c.url(b.href(a.$current.url,d).slice(1)),b.sync()},a}])}]),angular.module("negawattClientApp").config(["$provide",function(a){var b=angular.extend;a.decorator("leafletHelpers",["$delegate",function(a){var c={LeafletActiveAreaPlugin:{isLoaded:function(){return angular.isDefined(L.Map.prototype.setActiveArea)}}};return b(a,c),a}])}]),angular.module("negawattClientApp").factory("electricityMock",function(){return{electricity:[{timestamp:"1370034000",timestamp_rounded:"1370034000",datatime:"2013-06-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"95405",avg_power:"1.3491968844183966",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1370034000",timestamp_rounded:"1370034000",datatime:"2013-06-01 00:00:00",rate_type:"low",frequency:"2",kwh:"246449",avg_power:"4.66519367891613",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1370034000",timestamp_rounded:"1370034000",datatime:"2013-06-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"65174",avg_power:"1.233655928030715",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1370034000",timestamp_rounded:"1370034000",datatime:"2013-06-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"200440",avg_power:"3.7940238404323834",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1372626000",timestamp_rounded:"1372626000",datatime:"2013-07-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"104776",avg_power:"1.5316660862219962",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1372626000",timestamp_rounded:"1372626000",datatime:"2013-07-01 00:00:00",rate_type:"low",frequency:"2",kwh:"299827",avg_power:"5.865159048580788",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1372626000",timestamp_rounded:"1372626000",datatime:"2013-07-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"87198",avg_power:"1.705751680152517",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1372626000",timestamp_rounded:"1372626000",datatime:"2013-07-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"97324",avg_power:"1.9038330435188828",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1375304400",timestamp_rounded:"1375304400",datatime:"2013-08-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"96953",avg_power:"1.327475753562924",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1375304400",timestamp_rounded:"1375304400",datatime:"2013-08-01 00:00:00",rate_type:"low",frequency:"2",kwh:"330616",avg_power:"6.073323052376509",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1375304400",timestamp_rounded:"1375304400",datatime:"2013-08-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"88388",avg_power:"1.6154128188888233",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1375304400",timestamp_rounded:"1375304400",datatime:"2013-08-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"94640",avg_power:"1.7356053894181969",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1377982800",timestamp_rounded:"1377982800",datatime:"2013-09-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"89410",avg_power:"1.2389006223877623",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1377982800",timestamp_rounded:"1377982800",datatime:"2013-09-01 00:00:00",rate_type:"low",frequency:"2",kwh:"274203",avg_power:"5.190878643116481",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1377982800",timestamp_rounded:"1377982800",datatime:"2013-09-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"71987",avg_power:"1.3627713276466853",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1377982800",timestamp_rounded:"1377982800",datatime:"2013-09-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"141689",avg_power:"2.6822844989282983",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1380574800",timestamp_rounded:"1380574800",datatime:"2013-10-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"95533",avg_power:"1.3221051089366842",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1380574800",timestamp_rounded:"1380574800",datatime:"2013-10-01 00:00:00",rate_type:"low",frequency:"2",kwh:"268976",avg_power:"5.2616577637447435",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1380574800",timestamp_rounded:"1380574800",datatime:"2013-10-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"76183",avg_power:"1.4902779350818043",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1380574800",timestamp_rounded:"1380574800",datatime:"2013-10-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"201526",avg_power:"3.9422150910110543",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1383256800",timestamp_rounded:"1383256800",datatime:"2013-11-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"92231",avg_power:"1.2668649034692243",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1383256800",timestamp_rounded:"1383256800",datatime:"2013-11-01 00:00:00",rate_type:"low",frequency:"2",kwh:"268531",avg_power:"4.954339532181621",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1383256800",timestamp_rounded:"1383256800",datatime:"2013-11-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"89770",avg_power:"1.661246833236267",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1383256800",timestamp_rounded:"1383256800",datatime:"2013-11-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"185164",avg_power:"3.437817110783524",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1385848800",timestamp_rounded:"1385848800",datatime:"2013-12-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"102678",avg_power:"1.4170328786887694",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1385848800",timestamp_rounded:"1385848800",datatime:"2013-12-01 00:00:00",rate_type:"low",frequency:"2",kwh:"436666",avg_power:"8.541982546658582",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1385848800",timestamp_rounded:"1385848800",datatime:"2013-12-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"45053",avg_power:"0.8813182302999875",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1385848800",timestamp_rounded:"1385848800",datatime:"2013-12-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"117814",avg_power:"2.304655151074411",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1388527200",timestamp_rounded:"1388527200",datatime:"2014-01-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"107050",avg_power:"1.4388439622765872",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1388527200",timestamp_rounded:"1388527200",datatime:"2014-01-01 00:00:00",rate_type:"low",frequency:"2",kwh:"489617",avg_power:"9.096545840820504",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1388527200",timestamp_rounded:"1388527200",datatime:"2014-01-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"62184",avg_power:"1.1553519930069645",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1388527200",timestamp_rounded:"1388527200",datatime:"2014-01-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"147429",avg_power:"2.73640173050161",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1391205600",timestamp_rounded:"1391205600",datatime:"2014-02-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"91542",avg_power:"1.2062382364289506",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1391205600",timestamp_rounded:"1391205600",datatime:"2014-02-01 00:00:00",rate_type:"low",frequency:"2",kwh:"386687",avg_power:"7.218619968949093",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1391205600",timestamp_rounded:"1391205600",datatime:"2014-02-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"49098",avg_power:"0.9165545190787978",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1391205600",timestamp_rounded:"1391205600",datatime:"2014-02-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"120443",avg_power:"2.248413921178629",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1393624800",timestamp_rounded:"1393624800",datatime:"2014-03-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"89039",avg_power:"1.2990050116398681",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1393624800",timestamp_rounded:"1393624800",datatime:"2014-03-01 00:00:00",rate_type:"low",frequency:"2",kwh:"278681",avg_power:"5.680875124588405",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1393624800",timestamp_rounded:"1393624800",datatime:"2014-03-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"79355",avg_power:"1.6176408826794526",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1393624800",timestamp_rounded:"1393624800",datatime:"2014-03-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"165268",avg_power:"3.368965661689027",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1396299600",timestamp_rounded:"1396299600",datatime:"2014-04-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"86548",avg_power:"1.1386408385154152",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1396299600",timestamp_rounded:"1396299600",datatime:"2014-04-01 00:00:00",rate_type:"low",frequency:"2",kwh:"282719",avg_power:"5.212468318334998",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1396299600",timestamp_rounded:"1396299600",datatime:"2014-04-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"78174",avg_power:"1.4412875807754797",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1396299600",timestamp_rounded:"1396299600",datatime:"2014-04-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"119280",avg_power:"2.19915408345118",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1398891600",timestamp_rounded:"1398891600",datatime:"2014-05-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"105903",avg_power:"1.344294864223075",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1398891600",timestamp_rounded:"1398891600",datatime:"2014-05-01 00:00:00",rate_type:"low",frequency:"2",kwh:"312375",avg_power:"5.943209192932469",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1398891600",timestamp_rounded:"1398891600",datatime:"2014-05-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"90772",avg_power:"1.727017070944995",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1398891600",timestamp_rounded:"1398891600",datatime:"2014-05-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"170404",avg_power:"3.2420859847166765",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1401570000",timestamp_rounded:"1401570000",datatime:"2014-06-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"124309",avg_power:"1.513571079825686",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1401570000",timestamp_rounded:"1401570000",datatime:"2014-06-01 00:00:00",rate_type:"low",frequency:"2",kwh:"289757",avg_power:"5.335043830771561",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1401570000",timestamp_rounded:"1401570000",datatime:"2014-06-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"81813",avg_power:"1.5063515212386847",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1401570000",timestamp_rounded:"1401570000",datatime:"2014-06-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"202274",avg_power:"3.724295802178397",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1404162000",timestamp_rounded:"1404162000",datatime:"2014-07-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"140456",avg_power:"1.6264242749605486",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1404162000",timestamp_rounded:"1404162000",datatime:"2014-07-01 00:00:00",rate_type:"low",frequency:"2",kwh:"338530",avg_power:"6.530286096036434",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1404162000",timestamp_rounded:"1404162000",datatime:"2014-07-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"93349",avg_power:"1.800714271970921",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1404162000",timestamp_rounded:"1404162000",datatime:"2014-07-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"110567",avg_power:"2.1328518708792723",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1406840400",timestamp_rounded:"1406840400",datatime:"2014-08-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"124368",avg_power:"1.4343632887845663",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1406840400",timestamp_rounded:"1406840400",datatime:"2014-08-01 00:00:00",rate_type:"low",frequency:"2",kwh:"362216",avg_power:"6.557277010932361",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1406840400",timestamp_rounded:"1406840400",datatime:"2014-08-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"86798",avg_power:"1.5785786138515767",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1406840400",timestamp_rounded:"1406840400",datatime:"2014-08-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"88509",avg_power:"1.629033595208742",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1409518800",timestamp_rounded:"1409518800",datatime:"2014-09-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"116685",avg_power:"1.339973306773891",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1409518800",timestamp_rounded:"1409518800",datatime:"2014-09-01 00:00:00",rate_type:"low",frequency:"2",kwh:"293178",avg_power:"5.3980339300142575",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1409518800",timestamp_rounded:"1409518800",datatime:"2014-09-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"84077",avg_power:"1.5480375081708986",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1409518800",timestamp_rounded:"1409518800",datatime:"2014-09-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"239797",avg_power:"4.415173380495342",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1412110800",timestamp_rounded:"1412110800",datatime:"2014-10-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"116150",avg_power:"1.3787985849015127",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1412110800",timestamp_rounded:"1412110800",datatime:"2014-10-01 00:00:00",rate_type:"low",frequency:"2",kwh:"302315",avg_power:"5.751807491869142",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1412110800",timestamp_rounded:"1412110800",datatime:"2014-10-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"94259",avg_power:"1.793360272090729",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1412110800",timestamp_rounded:"1412110800",datatime:"2014-10-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"173007",avg_power:"3.291610345652659",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1414792800",timestamp_rounded:"1414792800",datatime:"2014-11-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"104854",avg_power:"1.2566396763764456",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1414792800",timestamp_rounded:"1414792800",datatime:"2014-11-01 00:00:00",rate_type:"low",frequency:"2",kwh:"269813",avg_power:"5.030070285312831",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1414792800",timestamp_rounded:"1414792800",datatime:"2014-11-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"83969",avg_power:"1.565417995935099",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1414792800",timestamp_rounded:"1414792800",datatime:"2014-11-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"204486",avg_power:"3.8121914388611913",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1417384800",timestamp_rounded:"1417384800",datatime:"2014-12-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"113653",avg_power:"1.3947268483472115",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1417384800",timestamp_rounded:"1417384800",datatime:"2014-12-01 00:00:00",rate_type:"low",frequency:"2",kwh:"465371",avg_power:"8.818368160357213",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1417384800",timestamp_rounded:"1417384800",datatime:"2014-12-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"54480",avg_power:"1.0325819168826693",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1417384800",timestamp_rounded:"1417384800",datatime:"2014-12-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"123932",avg_power:"2.3512867337016212",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1420063200",timestamp_rounded:"1420063200",datatime:"2015-01-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"128114",avg_power:"1.6244930205833747",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1420063200",timestamp_rounded:"1420063200",datatime:"2015-01-01 00:00:00",rate_type:"low",frequency:"2",kwh:"510343",avg_power:"9.396508287281206",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1420063200",timestamp_rounded:"1420063200",datatime:"2015-01-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"62320",avg_power:"1.1474449186241382",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1420063200",timestamp_rounded:"1420063200",datatime:"2015-01-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"140073",avg_power:"2.579041969566925",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1422741600",timestamp_rounded:"1422741600",datatime:"2015-02-01 00:00:00",rate_type:"flat",frequency:"2",kwh:"194703",avg_power:"1.8815922390796582",meter:"290",meter_category:"21",meter_account:"1",min_power_factor:"0"},{timestamp:"1422741600",timestamp_rounded:"1422741600",datatime:"2015-02-01 00:00:00",rate_type:"low",frequency:"2",kwh:"470822",avg_power:"8.668839803654445",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1422741600",timestamp_rounded:"1422741600",datatime:"2015-02-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"54601",avg_power:"1.0053205483988539",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1422741600",timestamp_rounded:"1422741600",datatime:"2015-02-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"121292",avg_power:"2.2332446546332068",meter:"291",meter_category:"12",meter_account:"1",min_power_factor:"0"},{timestamp:"1433106000",timestamp_rounded:"1433106000",datatime:"2015-06-01 00:00:00",rate_type:"low",frequency:"2",kwh:"9465.089626431465",avg_power:"18.16947528347373",meter:"420",meter_category:"19",meter_account:"1",min_power_factor:"0"},{timestamp:"1433106000",timestamp_rounded:"1433106000",datatime:"2015-06-01 00:00:00",rate_type:"mid",frequency:"2",kwh:"5105.519927293062",avg_power:"26.782475147396326",meter:"420",meter_category:"19",meter_account:"1",min_power_factor:"0"},{timestamp:"1433106000",timestamp_rounded:"1433106000",datatime:"2015-06-01 00:00:00",rate_type:"peak",frequency:"2",kwh:"14561.90033197403",avg_power:"41.194810539484024",meter:"420",meter_category:"19",meter_account:"1",min_power_factor:"0"}]}});